- hosts: all
  become: yes
  roles:
    - install-openjdk
    - install-maven
  tasks:
    - name: workarounds and requirements
      shell: |
        set -ex
        apt-get update -y
        echo $PATH
        sed -i -e '/127.0.0.1/ s/\(localhost\)/'$(hostname)' \1/' /etc/hosts
        apt-get install -y build-essential autoconf automake libtool cmake zlib1g-dev pkg-config libssl-dev libsasl2-dev

        # Install Docker
        type docker || curl -sSL https://get.docker.com/ | sh -

        # Install patched protoc-2.5.0
        curl -Lo /opt/protoc-2.5.0-aarch64.tar.gz https://github.com/liusheng/liusheng.github.io/files/3429342/protoc-2.5.0-aarch64.tar.gz
        mkdir -p /opt/protoc-2.5.0-aarch64 && tar zxf /opt/protoc-2.5.0-aarch64.tar.gz -C /opt/protoc-2.5.0-aarch64/
        echo /opt/protoc-2.5.0-aarch64/lib/ > /etc/ld.so.conf.d/protoc-2.5.0-aarch64.conf
        ldconfig
        export PATH=/opt/protoc-2.5.0-aarch64/bin:$PATH
        protoc --version

        # fix org.apache.hadoop.yarn.server.federation.policies.amrmproxy.TestLocalityMulticastAMRMProxyPolicy#testStressPolicy
        wget -O /opt/phantomjs-2.1.1-linux-aarch64.tar.bz2 https://github.com/liusheng/phantomjs/releases/download/2.1.1/phantomjs-2.1.1-linux-aarch64.tar.bz2
        tar jxvf /opt/phantomjs-2.1.1-linux-aarch64.tar.bz2 -C /opt/
        cp /opt/phantomjs-2.1.1-linux-aarch64/bin/phantomjs /usr/bin/

        # Building leveldb
        wget http://repository.timesys.com/buildsources/s/snappy/snappy-1.0.5/snappy-1.0.5.tar.gz
        tar -xvf snappy-1.0.5.tar.gz -C /opt/
        git clone http://github.com/huangtianhua/leveldbjni /opt/leveldbjni
        git clone http://github.com/huangtianhua/leveldb /opt/leveldb
        export SNAPPY_HOME=/opt/snappy-1.0.5
        export LEVELDBJNI_HOME=/opt/leveldbjni
        export LEVELDB_HOME=/opt/leveldb

        cd ${SNAPPY_HOME}
        # get the latest config.guess and config.sub
        wget -O config.guess "git.savannah.gnu.org/gitweb/?p=config.git;a=blob_plain;f=config.guess;hb=HEAD"
        wget -O config.sub "git.savannah.gnu.org/gitweb/?p=config.git;a=blob_plain;f=config.sub;hb=HEAD"
        ./configure --disable-shared --with-pic
        make

        cd ${LEVELDB_HOME}
        export LIBRARY_PATH=${SNAPPY_HOME}
        export C_INCLUDE_PATH=${LIBRARY_PATH}
        export CPLUS_INCLUDE_PATH=${LIBRARY_PATH}
        git apply ../leveldbjni/leveldb_aarch64.patch
        make libleveldb.a

        # fix the problem: 'aclocal-1.14' is missing on your system
        cd ../
        sudo apt-get install autoconf -y
        wget http://ftp.gnu.org/gnu/automake/automake-1.14.tar.gz
        tar -zxvf automake-1.14.tar.gz
        cd automake-1.14
        ./bootstrap.sh
        ./configure
        sudo make
        sudo make install

        # cd ${LEVELDBJNI_HOME}
        # fix error: configure.ac:36: error: required file 'autotools/compile' not found
        # mkdir -p ${LEVELDBJNI_HOME}/leveldbjni-linux64-aarch64/target/native-build/autotools/
        # cp /usr/local/share/automake-1.14/compile ${LEVELDBJNI_HOME}/leveldbjni-linux64-aarch64/target/native-build/autotools/
        # # build leveldbjni-linux64-aarch64
        # mvn -e -B install -P download -P linux64-aarch64 -DskipTests
        # # build leveldbjni-all
        # mvn -e -B install -P download -P all -DskipTests

        # Test Hadoop standalone simply
        # pushd /opt/hadoop-3.3.0-SNAPSHOT/
        # mkdir input
        # cp etc/hadoop/*.xml input
        # hadoop jar share/hadoop/mapreduce/hadoop-mapreduce-examples-3.3.0-SNAPSHOT.jar grep input output 'dfs[a-z.]+'
        # cat output/*
        # popd

        # pushd /opt/hadoop-3.3.0-SNAPSHOT/
        # nohup bin/mapred minicluster -rmport 9966 -jhsport 9977 -nodfs 2>&1 &
        # popd
        # sleep 720000000

        # mvn test -B -e -fn | tee "{{ ansible_user_dir }}/workspace/logs/hadoop_test.log"

      args:
        executable: /bin/bash
        chdir: '{{ zuul.project.src_dir }}'
      environment: '{{ global_env }}'

    - name: Install hadoop and run tests
      become: no
      shell: |
        set -ex

        echo "I am zuul user"
        whoami

        # Install protoc-gen-grpc-java for ARM platform
        mkdir -p ~/.m2/repository/io/grpc/protoc-gen-grpc-java/1.15.1/
        pushd ~/.m2/repository/io/grpc/protoc-gen-grpc-java/1.15.1/
        wget http://home.apache.org/~aajisaka/repository/io/grpc/protoc-gen-grpc-java/1.15.1/protoc-gen-grpc-java-1.15.1-linux-aarch_64.exe
        wget http://home.apache.org/~aajisaka/repository/io/grpc/protoc-gen-grpc-java/1.15.1/protoc-gen-grpc-java-1.15.1.pom
        wget http://home.apache.org/~aajisaka/repository/io/grpc/protoc-gen-grpc-java/1.15.1/protoc-gen-grpc-java-1.15.1.pom.sha1
        popd

        cd '{{ ansible_user_dir }}/{{ zuul.project.src_dir }}'
        wget -O leveldbjni-all-99-master-SNAPSHOT.jar.tar.gz https://github.com/liusheng/package/releases/download/leveldbjni-1.8-aarch64/leveldbjni-all-99-master-SNAPSHOT.jar.tar.gz
        mvn install:install-file -DgroupId=org.fusesource.leveldbjni -DartifactId=leveldbjni-all -Dversion=1.8 -Dpackaging=jar -Dfile=/opt/leveldbjni/leveldbjni-all/target/leveldbjni-all-99-master-SNAPSHOT.jar

        # Install hadoop in Maven local repo
        mvn clean install -e -B -DskipTests 2>&1 | tee "{{ ansible_user_dir }}/workspace/logs/hadoop_build.log"

        # Compile hadoop
        # mvn -B package -Pdist,native -Psrc -Dtar -DskipTests -Dmaven.javadoc.skip 2>&1 | tee "{{ ansible_user_dir }}/workspace/logs/hadoop_package.log"
        mvn -B package -Pdist -Dtar -DskipTests -Dmaven.javadoc.skip 2>&1 | tee "{{ ansible_user_dir }}/workspace/logs/hadoop_package.log"
        cp -r hadoop-dist/target/hadoop-3.3.0-SNAPSHOT /opt/
        export PATH=/opt/hadoop-3.3.0-SNAPSHOT/bin:$PATH
        export JAVA_HOME=`dirname $(dirname $(update-alternatives --list javac))`
        hadoop version
        # hadoop checknative -a

        sleep 72000000000
        mvn test -B -e -fn | tee "{{ ansible_user_dir }}/workspace/logs/hadoop_test.log"
      args:
        executable: /bin/bash
        chdir: '{{ zuul.project.src_dir }}'
      environment: '{{ global_env }}'
