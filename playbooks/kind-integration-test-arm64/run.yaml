---
- hosts: all
  become: yes
  roles:
    - role: config-golang
      go_version: 1.12.6
      arch: arm64
    - role: install-docker-ce
      arch: arm64

  tasks:
    - name: build KIND against k/k master using bazel
      shell:
        cmd: |
          mkdir -p $GOPATH/src/k8s.io/kubernetes
          mkdir -p $GOPATH/src/sigs.k8s.io/kind
          ln -sf '{{ zuul.project.src_dir }}'/kind $GOPATH/src/sigs.k8s.io/kind
          ln -sf '{{ zuul.project.src_dir }}'/kubernetes $GOPATH/src/k8s.io/kubernetes
          cd '{{ zuul.project.src_dir }}'/kind && go install .
          sed -i '/kind build node-image/i\    kind build base-image --image kindest/base:latest --source '{{ zuul.project.src_dir }}'/kind/images/base' \
            '{{ zuul.project.src_dir }}'/kind/hack/ci/e2e.sh
          sed 's/kind build node-image/kind build node-image --base-image kindest/base:latest/' '{{ zuul.project.src_dir }}'/kind/hack/ci/e2e.sh
                    cd '{{ zuul.project.src_dir }}'/test-infra/kubetest && go install .
          cd '{{ zuul.project.src_dir }}'/kubernetes && bazel build //cmd/kubectl //test/e2e:e2e.test //vendor/github.com/onsi/ginkgo/ginkgo
          '{{ zuul.project.src_dir }}'/kind/hack/ci/e2e.sh
        executable: /bin/bash
      environment: '{{ global_env }}'
